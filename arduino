#include <Arduino.h>
#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include "HX711.h"

// ===== WiFi / WebServer =====
#include <WiFi.h>
#include <WebServer.h>

// -----------------------------------------------------
// 0) WiFi AP ÏÑ§Ï†ï
// -----------------------------------------------------
const char* AP_SSID = "SmartBarricade_AP";
const char* AP_PASS = "12345678";
WebServer server(80);

float g_lastW1 = 0.0f;
float g_lastW2 = 0.0f;
float g_lastW3 = 0.0f;
bool g_over1 = false;
bool g_over2 = false;
bool g_over3 = false;
bool g_overloaded = false;
bool g_autoModeHttp = true;
int g_actuatorState = 0; // 0: RETRACT (Îã´Ìûò), 1: EXTEND (Ïó¥Î¶º), -1: STOP (Ï†ïÏßÄ)

// 1) HX711 & Î≥¥Ï†ïÍ∞í ÏÑ§Ï†ï
const int LOADCELL1_DOUT_PIN = 12;
const int LOADCELL1_SCK_PIN  = 13;
const int LOADCELL2_DOUT_PIN = 4;
const int LOADCELL2_SCK_PIN  = 5;
const int LOADCELL3_DOUT_PIN = 16;
const int LOADCELL3_SCK_PIN  = 17;

HX711 scale1, scale2, scale3;

const float SET_SCALE1 = -9.425f;
const float SET_SCALE2 = -9.4f;
const float SET_SCALE3 = 10.6f;

const bool USE_LOADCELL1 = true;
const bool USE_LOADCELL2 = true;
const bool USE_LOADCELL3 = true;


// 2) Î¶¥Î†àÏù¥ ÌïÄ ÏÑ§Ï†ï
const int IN1 = 33;
const int IN2 = 26;
const int IN3 = 27;
const int IN4 = 14;

#define RELAY_ACTIVE_LOW 1
#if RELAY_ACTIVE_LOW
const int RELAY_ON  = LOW;
const int RELAY_OFF = HIGH;
#else
const int RELAY_ON  = HIGH;
const int RELAY_OFF = LOW;
#endif


const float THRESHOLD = 10000.0f;
const int NUM_SAMPLES = 5;
const float ZERO_DEADZONE = 200.0f;

// -----------------------------------------------------
// 4) ÏÉÅÌÉú Î≥ÄÏàò
// -----------------------------------------------------
int actuatorState = 0; // 0: RETRACT (Îã´Ìûò), 1: EXTEND (Ïó¥Î¶º), -1: STOP (Ï†ïÏßÄ)
bool autoMode = true;
const unsigned long EXTEND_HOLD_MS = 10UL * 1000UL;
unsigned long extendHoldUntil = 0;

void startAP();
void actuatorStop();

// =====================================================
// Ïú†Ìã∏ Ìï®Ïàò
// =====================================================
float medianFilter(float arr[], int n) {
    for (int i = 0; i < n - 1; i++)
        for (int j = i + 1; j < n; j++)
            if (arr[j] < arr[i]) {
                float t = arr[i];
                arr[i] = arr[j];
                arr[j] = t;
            }
    return arr[n / 2];
}

float applyDeadzone(float v) {
    if (v > -ZERO_DEADZONE && v < ZERO_DEADZONE) return 0.0f;
    return v;
}

void printRelayState(const char* label) {
    Serial.print(label);
    Serial.print(" IN1="); Serial.print(digitalRead(IN1));
    Serial.print(" IN2="); Serial.print(digitalRead(IN2));
    Serial.print(" IN3="); Serial.print(digitalRead(IN3));
    Serial.print(" IN4="); Serial.println(digitalRead(IN4));
}

void setModeAuto(const char* reason) {
    if (!autoMode) Serial.printf("### MODE -> AUTO (%s)\n", reason);
    autoMode = true;
    g_autoModeHttp = true;
    extendHoldUntil = 0;
}

// ÏàòÏ†ïÎêú setModeManual: doStop=trueÏùº Îïå RETRACT ÏÉÅÌÉúÎ°ú Ï†ÑÌôò
void setModeManual(const char* reason, bool doStop) {
    if (autoMode) Serial.printf("### MODE -> MANUAL (%s)\n", reason);
    autoMode = false;
    g_autoModeHttp = false;
    extendHoldUntil = 0;

    if (doStop) {
        // Í∏∞Ï°¥: STOP (ALL OFF)
        // ÏàòÏ†ï: RETRACT (IN1, IN3 ON) ÏÉÅÌÉúÎ°ú Ï†ÑÌôòÌïòÏó¨ Í∏∞Î≥∏ ÏÉÅÌÉú Ïú†ÏßÄ
        actuatorStop(); // ÏùºÎã® Ï†ïÏßÄÌïòÏó¨ Î™®ÌÑ∞ ÏïàÏ†Ñ Î≥¥Ïû•
        // Í∞ïÏ†ú Ï†ïÏßÄ ÌõÑ RETRACT Ï†ÑÌôò ÏãúÏóêÎèÑ Î¶¥Î†àÏù¥ ÏïàÏ†ïÌôî ÏßÄÏó∞Ïù¥ ÌïÑÏöîÌï† Ïàò ÏûàÏäµÎãàÎã§.
        delay(10); 
        
        digitalWrite(IN1, RELAY_ON);
        digitalWrite(IN3, RELAY_ON);

        actuatorState = 0; // RETRACT ÏÉÅÌÉú
        g_actuatorState = 0;
        printRelayState("-> Actuator: RETRACT (Manual Mode Start)");
    }
}

// =====================================================
// Î¶¥Î†àÏù¥ Ï†úÏñ¥ (actuatorStop() Ïû¨Ï∂îÍ∞Ä)
// =====================================================

void actuatorStop() {
    if (actuatorState == -1) return; // Ïù¥ÎØ∏ Ï†ïÏßÄ ÏÉÅÌÉúÎùºÎ©¥ Î¶¨ÌÑ¥

    actuatorState = -1;
    g_actuatorState = -1;
    
    // Î™®Îì† Î¶¥Î†àÏù¥Î•º OFFÌïòÏó¨ Î™®ÌÑ∞ Ï†ïÏßÄ
    digitalWrite(IN1, RELAY_OFF);
    digitalWrite(IN2, RELAY_OFF);
    digitalWrite(IN3, RELAY_OFF);
    digitalWrite(IN4, RELAY_OFF);

    printRelayState("-> Actuator: STOP");
}


void actuatorRetract() {
    // Ïù¥ÎØ∏ RETRACT(0) ÏÉÅÌÉúÎùºÎ©¥ Î¶¨ÌÑ¥ÌïòÏó¨ Î∂àÌïÑÏöîÌïú Î¶¥Î†àÏù¥ ÎèôÏûëÏùÑ ÎßâÏùå
    if (actuatorState == 0) return; 
    
    actuatorStop(); // ÎèôÏûë Ï†Ñ Î∞òÎìúÏãú Ï†ïÏßÄ

    // üõë Î¶¥Î†àÏù¥Ïùò Í∏∞Í≥ÑÏ†Å Ï†ëÏ†ê ÏïàÏ†ïÌôî ÏãúÍ∞Ñ (10ms) Ï∂îÍ∞Ä
    delay(10); 
    
    actuatorState = 0;
    g_actuatorState = 0;

    // RETRACT (Îã´Ìûò) ÏãúÏûë
    digitalWrite(IN1, RELAY_ON);
    digitalWrite(IN3, RELAY_ON);

    printRelayState("-> Actuator: close (1,3 ON)");
}

void actuatorExtend() {
    // Ïù¥ÎØ∏ EXTEND(1) ÏÉÅÌÉúÎùºÎ©¥ Î¶¨ÌÑ¥ÌïòÏó¨ Î∂àÌïÑÏöîÌïú Î¶¥Î†àÏù¥ ÎèôÏûëÏùÑ ÎßâÏùå
    if (actuatorState == 1) return;
    
    actuatorStop(); // ÎèôÏûë Ï†Ñ Î∞òÎìúÏãú Ï†ïÏßÄ
    
    // üõë Î¶¥Î†àÏù¥Ïùò Í∏∞Í≥ÑÏ†Å Ï†ëÏ†ê ÏïàÏ†ïÌôî ÏãúÍ∞Ñ (10ms) Ï∂îÍ∞Ä
    delay(10); 
    
    actuatorState = 1;
    g_actuatorState = 1;

    // EXTEND (Ïó¥Î¶º) ÏãúÏûë
    digitalWrite(IN2, RELAY_ON);
    digitalWrite(IN4, RELAY_ON);

    printRelayState("-> Actuator: open (2,4 ON)");
}

// =====================================================
// BLE Í¥ÄÎ†®
// =====================================================
#define SERVICE_UUID      "12345678-1234-1234-1234-1234567890ab"
#define CHAR_UUID_NOTIFY  "abcd1234-1234-5678-9999-abcdef123456"
#define CHAR_UUID_WRITE   "abcd0002-1234-5678-9999-abcdef123456"

BLEServer* pServer = nullptr;
BLECharacteristic* pNotifyChar = nullptr;
BLEAdvertising* pAdvertising = nullptr;

bool deviceConnected = false;
bool oldDeviceConnected = false;

class MyServerCallbacks : public BLEServerCallbacks {
    void onConnect(BLEServer*) override {
        deviceConnected = true;
        Serial.println("BLE Central Ïó∞Í≤∞Îê®");
        WiFi.softAPdisconnect(true);
    }
    void onDisconnect(BLEServer*) override {
        deviceConnected = false;
        Serial.println("BLE Central Ìï¥Ï†ú -> AP Ïû¨ÏãúÏûë");
        startAP();
    }
};

// ÏàòÏ†ï: AUTO Î™®ÎìúÏóêÏÑú Action Î™ÖÎ†π Ï∞®Îã® Î∞è STOP Î™ÖÎ†π actuatorStop() ÏÇ¨Ïö©
class CmdCallback : public BLECharacteristicCallbacks {
    void onWrite(BLECharacteristic* pChar) override {
        String cmd = String(pChar->getValue().c_str());
        cmd.trim(); cmd.toUpperCase();

        Serial.printf("BLE CMD: [%s]\n", cmd.c_str());

        if (cmd == "MODE_AUTO") setModeAuto("BLE");
        else if (cmd == "MODE_MANUAL") setModeManual("BLE", true);
        // MANUAL Î™®ÎìúÏùº ÎïåÎßå Ïï°Ï∂îÏóêÏù¥ÌÑ∞ Ï†úÏñ¥ ÌóàÏö©
        else if (!autoMode && cmd == "EXTEND") { setModeManual("BLE EXTEND", false); actuatorExtend(); }
        else if (!autoMode && cmd == "RETRACT") { setModeManual("BLE RETRACT", false); actuatorRetract(); }
        else if (!autoMode && cmd == "STOP") { setModeManual("BLE STOP", false); 
            actuatorStop(); // actuatorStop() Ìï®Ïàò ÏÇ¨Ïö©
        }
        else if (autoMode && (cmd == "EXTEND" || cmd == "RETRACT" || cmd == "STOP")) {
            Serial.println("-> BLE CMD: AUTO Î™®ÎìúÏóêÏÑú Ïï°Ï∂îÏóêÏù¥ÌÑ∞ Ï†úÏñ¥ Î¨¥ÏãúÎê®.");
        }
    }
};

void disconnectBleForWifi() {
    if (deviceConnected && pServer) {
        Serial.println("[HTTP] BLE Disconnect");
        pServer->disconnect(0);
    }
}

// =====================================================
// HTTP Ìï∏Îì§Îü¨ (handleCmd ÏàòÏ†ïÎê®: actuatorStop() ÏÇ¨Ïö©)
// =====================================================
void handleStatus() {
    disconnectBleForWifi(); 
    String json = "{";
    json += "\"W1\":" + String(g_lastW1, 1) + ",";
    json += "\"W2\":" + String(g_lastW2, 1) + ",";
    json += "\"W3\":" + String(g_lastW3, 1) + ",";
    json += "\"over1\":" + String(g_over1) + ",";
    json += "\"over2\":" + String(g_over2) + ",";
    json += "\"over3\":" + String(g_over3) + ",";
    json += "\"overloaded\":" + String(g_overloaded) + ",";
    json += "\"autoMode\":" + String(g_autoModeHttp) + ",";
    json += "\"actuatorState\":" + String(g_actuatorState);
    json += "}";
    server.send(200, "application/json", json);
}

void handleCmd() {
    disconnectBleForWifi();

    String mode    = server.arg("mode");    mode.toUpperCase();
    String action = server.arg("action"); action.toUpperCase();

    // 1. Î™®Îìú Î≥ÄÍ≤Ω Ï≤òÎ¶¨ (mode Ïù∏ÏûêÍ∞Ä ÏûàÏùÑ ÎïåÎßå Ïã§Ìñâ)
    if (mode == "AUTO") setModeAuto("HTTP /cmd");
    else if (mode == "MANUAL") setModeManual("HTTP /cmd", true);

    // 2. Ïï°Ï∂îÏóêÏù¥ÌÑ∞ ÎèôÏûë Ï≤òÎ¶¨ (action Ïù∏ÏûêÍ∞Ä ÏûàÏùÑ ÎïåÎßå Ïã§Ìñâ)
    if (action.length() > 0) {
        if (!autoMode) { // MANUAL Î™®ÎìúÏùº ÎïåÎßå Ïï°Ï∂îÏóêÏù¥ÌÑ∞ Ï†úÏñ¥ ÌóàÏö©
            setModeManual("HTTP ACTION", false); // MANUAL Î™®Îìú Ïú†ÏßÄ (doStop=false)
            if (action == "EXTEND") actuatorExtend();
            else if (action == "RETRACT") actuatorRetract();
            else if (action == "STOP") actuatorStop(); // actuatorStop() Ìï®Ïàò ÏÇ¨Ïö©
        } else {
            Serial.println("-> HTTP CMD: AUTO Î™®ÎìúÏóêÏÑú Ïï°Ï∂îÏóêÏù¥ÌÑ∞ Ï†úÏñ¥ Î¨¥ÏãúÎê®.");
        }
    }

    String json = "{";
    json += "\"ok\":1,";
    json += "\"mode\":\"" + String(autoMode ? "AUTO" : "MANUAL") + "\",";
    json += "\"action\":\"" + action + "\",";
    json += "\"actuatorState\":" + String(g_actuatorState);
    json += "}";

    server.send(200, "application/json", json);
}

void startWebServer() {
    server.on("/status", HTTP_ANY, handleStatus);
    server.on("/cmd",    HTTP_ANY, handleCmd);
    server.begin();
    Serial.println("-> WebServer ÏãúÏûë (/status, /cmd)");
}

// =====================================================
// WiFi AP
// =====================================================
void startAP() {
    Serial.println("-> AP Î™®Îìú ÏãúÏûë...");
    WiFi.mode(WIFI_AP);
    bool ok = WiFi.softAP(AP_SSID, AP_PASS);

    if (ok) {
        Serial.println("-> AP ÌôúÏÑ±ÌôîÎê®");
        Serial.printf("SSID: %s\nPASS: %s\n", AP_SSID, AP_PASS);
        Serial.print("AP IP: "); Serial.println(WiFi.softAPIP());
    } else Serial.println("-> AP ÏãúÏûë Ïã§Ìå®");
}

// =====================================================
// SETUP
// =====================================================
void setup() {
    Serial.begin(115200);
    delay(1000);

    pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
    pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);

    // Ï¥àÍ∏∞ ÏÉÅÌÉú: RETRACT (IN1, IN3 ON) ÏÉÅÌÉúÎ°ú ÏãúÏûë (Í∏∞Î≥∏ ÏÉÅÌÉú)
    digitalWrite(IN2, RELAY_OFF);
    digitalWrite(IN4, RELAY_OFF);
    digitalWrite(IN1, RELAY_ON);
    digitalWrite(IN3, RELAY_ON);
    
    actuatorState = 0; // Ï¥àÍ∏∞ ÏÉÅÌÉúÎ•º RETRACT(0)Î°ú ÏÑ§Ï†ï

    printRelayState("Ï¥àÍ∏∞ RETRACT (1,3 ON)");

    if (USE_LOADCELL1) { scale1.begin(LOADCELL1_DOUT_PIN, LOADCELL1_SCK_PIN); scale1.set_scale(SET_SCALE1); }
    if (USE_LOADCELL2) { scale2.begin(LOADCELL2_DOUT_PIN, LOADCELL2_SCK_PIN); scale2.set_scale(SET_SCALE2); }
    if (USE_LOADCELL3) { scale3.begin(LOADCELL3_DOUT_PIN, LOADCELL3_SCK_PIN); scale3.set_scale(SET_SCALE3); }

    Serial.println("Tare...");
    delay(500);
    if (USE_LOADCELL1) scale1.tare(10);
    if (USE_LOADCELL2) scale2.tare(10);
    if (USE_LOADCELL3) scale3.tare(10);

    // BLE Ï¥àÍ∏∞Ìôî
    BLEDevice::init("SmartLoadcell-A10");
    pServer = BLEDevice::createServer();
    pServer->setCallbacks(new MyServerCallbacks());

    BLEService* pService = pServer->createService(SERVICE_UUID);

    pNotifyChar = pService->createCharacteristic(
        CHAR_UUID_NOTIFY,
        BLECharacteristic::PROPERTY_READ | BLECharacteristic::PROPERTY_NOTIFY
    );
    pNotifyChar->addDescriptor(new BLE2902()); // CCCD ÎîîÏä§ÌÅ¨Î¶ΩÌÑ∞

    BLECharacteristic* pWriteChar =
        pService->createCharacteristic(CHAR_UUID_WRITE, BLECharacteristic::PROPERTY_WRITE);
    pWriteChar->setCallbacks(new CmdCallback());

    pService->start();
    pAdvertising = BLEDevice::getAdvertising();
    pAdvertising->addServiceUUID(SERVICE_UUID);
    BLEDevice::startAdvertising();

    startAP();
    startWebServer();
}

// =====================================================
// LOOP
// =====================================================
void loop() {
    
    server.handleClient();

    float samples[NUM_SAMPLES];
    float lastW1 = 0, lastW2 = 0, lastW3 = 0;

    static unsigned long lastLogMs = 0;  // <-- Î°úÍ∑∏ Ï∂úÎ†• Ï£ºÍ∏∞ Ï†úÏñ¥Ïö© (Ï∂îÍ∞Ä)

    // 5Í∞úÏùò ÏÉòÌîåÏùÑ ÏùΩÏñ¥ÏÑú Ï§ëÏïôÍ∞í ÌïÑÌÑ∞ÎßÅ Ï§ÄÎπÑ
    for (int i = 0; i < NUM_SAMPLES; i++) {
        float w1 = USE_LOADCELL1 ? scale1.get_units(1) : 0;
        float w2 = USE_LOADCELL2 ? scale2.get_units(1) : 0;
        float w3 = USE_LOADCELL3 ? scale3.get_units(1) : 0;

        lastW1 = w1; lastW2 = w2; lastW3 = w3;
        samples[i] = w1 + w2 + w3;
        delay(2);
    }

    float medTotal = applyDeadzone(medianFilter(samples, NUM_SAMPLES));
    lastW1 = applyDeadzone(lastW1);
    lastW2 = applyDeadzone(lastW2);
    lastW3 = applyDeadzone(lastW3);

    unsigned long nowMs = millis();

    bool over1 = USE_LOADCELL1 && (lastW1 > THRESHOLD);
    bool over2 = USE_LOADCELL2 && (lastW2 > THRESHOLD);
    bool over3 = USE_LOADCELL3 && (lastW3 > THRESHOLD);

    bool overNow = (over1 || over2 || over3);

    // Ï†ÑÏó≠ Î≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏ (HTTP /statusÏö©)
    g_lastW1 = lastW1;
    g_lastW2 = lastW2;
    g_lastW3 = lastW3;
    g_over1 = over1;
    g_over2 = over2;
    g_over3 = over3;

    // Ïò§Î≤ÑÏõ®Ïù¥Ìä∏ Î∞úÏÉù Ïãú Hold time ÏóÖÎç∞Ïù¥Ìä∏
    if (overNow) {
        unsigned long candidate = nowMs + EXTEND_HOLD_MS;
        if (candidate > extendHoldUntil) extendHoldUntil = candidate;
    }

    bool inExtendHoldWindow = (nowMs < extendHoldUntil);
    bool overloaded = overNow || inExtendHoldWindow;

    g_overloaded = overloaded;
    g_autoModeHttp = autoMode;

    // ÏãúÎ¶¨Ïñº Î™®ÎãàÌÑ∞ÎßÅ Ï∂úÎ†•
        // ÏãúÎ¶¨Ïñº Î™®ÎãàÌÑ∞ÎßÅ Ï∂úÎ†• (300msÎßàÎã§ Ìïú Î≤àÎßå Ï∞çÍ∏∞)
    if (nowMs - lastLogMs >= 300) {   // 300ms = 0.3Ï¥à, ÌïÑÏöîÌïòÎ©¥ 500ÏúºÎ°ú ÎäòÎ†§ÎèÑ Îê®
        lastLogMs = nowMs;

        Serial.printf(
            "W1=%.1f | W2=%.1f | W3=%.1f | TOTAL=%.1f | over1=%c | over2=%c | over3=%c | hold=%s | mode=%s | actuator=%s\n",
            lastW1, lastW2, lastW3, medTotal,
            over1?'Y':'N', over2?'Y':'N', over3?'Y':'N',
            inExtendHoldWindow?"ON":"OFF",
            autoMode?"AUTO":"MANUAL",
            actuatorState==1?"EXTEND":(actuatorState==0?"RETRACT":"STOP")
        );
    }


    // ÏûêÎèô Î™®Îìú Ï†úÏñ¥ Î°úÏßÅ
    if (autoMode) {
        if (overloaded) {
            if (actuatorState != 1) actuatorExtend();
        } else {
            if (actuatorState != 0) actuatorRetract();
        }
    }

    // BLE Notify Ï†ÑÏÜ°
    if (deviceConnected && pNotifyChar) {
        char payload[64];
        // actuatorStateÎ•º 0:RETRACT, 1:EXTEND, -1:STOPÏúºÎ°ú ÏÇ¨Ïö©ÌïòÎØÄÎ°ú,
        // BLE Ï†ÑÏÜ° ÏãúÏóêÎäî 0:RETRACT, 1:EXTENDÎßå ÏÇ¨Ïö©ÌïúÎã§Í≥† Í∞ÄÏ†ïÌïòÍ≥† -1ÏùÄ 0ÏúºÎ°ú Ï†ÑÏÜ°Ìï©ÎãàÎã§.
        int bleActuatorState = (actuatorState == 1) ? 1 : 0; 
        
        snprintf(payload, sizeof(payload),
            "W,%.1f,%.1f,%.1f,%d,%d,%d\n", // W1, W2, W3, overloaded(1/0), autoMode(1/0), actuatorState(1/0)
            lastW1, lastW2, lastW3,
            overloaded ? 1 : 0,
            autoMode ? 1 : 0,
            bleActuatorState
        );
        pNotifyChar->setValue((uint8_t*)payload, strlen(payload));
        pNotifyChar->notify();
    }

    // BLE Ïó∞Í≤∞ Ìï¥Ï†ú ÌõÑ Í¥ëÍ≥† Ïû¨ÏãúÏûë Î°úÏßÅ
    if (!deviceConnected && oldDeviceConnected) {
        delay(200);
        oldDeviceConnected = deviceConnected;
    }

    if (deviceConnected && !oldDeviceConnected) {
        oldDeviceConnected = deviceConnected;
    }

    delay(5);
}
