#include "HX711.h"

// =======================
// 1) HX711 & 보정값 설정
// =======================

// HX711 핀 (ESP32에서 안전한 GPIO)
const int LOADCELL_DOUT_PIN = 12;
const int LOADCELL_SCK_PIN  = 13;

// HX711 객체
HX711 scale;

// SCALE만 고정, OFFSET은 자동(tare)
const float SET_SCALE  = 8.686992f;  // 캘리브레이션에서 얻은 값

// =======================
// 2) 릴레이 핀 설정
// =======================

const int IN1 = 25;   // Extend 1
const int IN2 = 26;   // Extend 2
const int IN3 = 27;   // Retract 1
const int IN4 = 14;   // Retract 2

// =======================
// 3) 알고리즘 파라미터
// =======================

// 임계값 (g 단위)
const float THRESHOLD = 15000.0f;   // 현장에서 조정

// 샘플 개수 (홀수 권장)
const int NUM_SAMPLES = 9;

// =======================
// 4) 필터 함수 (중간값 필터)
// =======================

float medianFilter(float arr[], int n) {
  for (int i = 0; i < n - 1; i++) {
    for (int j = i + 1; j < n; j++) {
      if (arr[j] < arr[i]) {
        float t = arr[i];
        arr[i] = arr[j];
        arr[j] = t;
      }
    }
  }
  return arr[n / 2];
}

// =======================
// 5) 셋업
// =======================

void setup() {
  Serial.begin(115200);

  // HX711 초기화
  scale.begin(LOADCELL_DOUT_PIN, LOADCELL_SCK_PIN);
  scale.set_scale(SET_SCALE);

  // ⚠ 전원 켰을 때 아무것도 안 올려놓은 상태에서 자동 OFFSET 계산
  Serial.println("Tare... remove all weight");
  delay(500);
  scale.tare(10);   // 10회 평균으로 OFFSET 자동 계산

  long offsetNow = scale.get_offset();
  Serial.print("OFFSET(auto) = ");
  Serial.println(offsetNow);

  // 릴레이 출력 설정
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);

  // 기본 릴레이 상태 (OFF)
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, HIGH);

  Serial.println("Loadcell + Median Filter + Relay ready.");
}

// =======================
// 6) 메인 루프
// =======================

void loop() {
  float samples[NUM_SAMPLES];

  // 중간값 필터용 샘플 여러 번 읽기
  for (int i = 0; i < NUM_SAMPLES; i++) {
    samples[i] = scale.get_units(5);   // 내부 평균 5번 후 값
    delay(30);
  }

  float med = medianFilter(samples, NUM_SAMPLES);

  Serial.print("Weight (median): ");
  Serial.print(med, 2);
  Serial.println(" g");

  // ====== 제어 로직 ======

  // 과부하 상태 → 구조 게이트 EXTEND
  if (med > THRESHOLD) {
    Serial.println("⚠️ Over Pressure → Actuator EXTEND");

    digitalWrite(IN1, HIGH);
    digitalWrite(IN2, LOW);
    digitalWrite(IN3, HIGH);
    digitalWrite(IN4, LOW);
  }
  // 정상 상태 → 구조 게이트 RETRACT
  else {
    Serial.println("Normal → Actuator RETRACT");

    digitalWrite(IN1, LOW);
    digitalWrite(IN2, HIGH);
    digitalWrite(IN3, LOW);
    digitalWrite(IN4, HIGH);
  }

  delay(200);
}
