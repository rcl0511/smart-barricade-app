/*******************************************************
 * ESP32-S3 FSR ÏÑºÏÑú + BLE Notify + WiFi POST
 * (LED + JSON Ìè¨Ìï®, Render HTTPS Ïó∞Îèô)
 *******************************************************/

#include <WiFi.h>
#include <WiFiClientSecure.h>   // ‚úÖ HTTPSÏö©
#include <HTTPClient.h>

#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

// ======== WIFI SECTION ========
const char* WIFI_SSID     = "U+Net97A4";
const char* WIFI_PASSWORD = "5F8#4527HE";

// ‚úÖ RenderÏóê Ïò¨Î¶∞ FastAPI ÏÑúÎ≤Ñ Ï£ºÏÜå
const char* SERVER_URL = "https://android-qdfu.onrender.com/sensor";

// HTTPSÏö© ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ (Ï†ÑÏó≠)
WiFiClientSecure secureClient;

// ======== BLE SECTION ========
#define SERVICE_UUID        "12345678-1234-1234-1234-1234567890ab"
#define CHARACTERISTIC_UUID "abcd1234-1234-5678-9999-abcdef123456"
BLECharacteristic* pCharacteristic;

// ======== SENSOR SECTION ========
// ‚ö† ESP32-S3ÏóêÏÑú Ïã§Ï†úÎ°ú ADC Í∞ÄÎä•Ìïú ÌïÄÏù∏ÏßÄ ÌôïÏù∏ ÌïÑÏöî (Ïòà: GPIO34 Ïì∏ ÎïåÎäî 34Î°ú)
const int SENSOR_PIN = 1;
const int THRESHOLD  = 700;


// ======== WIFI Ïó∞Í≤∞ ========
void connectWiFi() {
  Serial.println("üîå WiFi Ïó∞Í≤∞Ï§ë...");
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  while (WiFi.status() != WL_CONNECTED) {
    delay(400);
    Serial.print(".");
  }

  Serial.println("\nüì∂ WiFi Ïó∞Í≤∞ ÏôÑÎ£å!");
  Serial.print("IP Ï£ºÏÜå: ");
  Serial.println(WiFi.localIP());

  // ‚úÖ HTTPS ÌÖåÏä§Ìä∏Î•º ÏúÑÌï¥ Ïù∏Ï¶ùÏÑú Í≤ÄÏ¶ù ÎπÑÌôúÏÑ±Ìôî (Ïã§ÏäµÏö©)
  secureClient.setInsecure();
}


// ======== ÏÑúÎ≤Ñ POST ========
void postToServer(int val, int led) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ö† WiFi ÎÅäÍπÄ ‚Üí Ïû¨Ïó∞Í≤∞");
    connectWiFi();
  }

  HTTPClient http;

  // ‚úÖ HTTPS + Ïª§Ïä§ÌÖÄ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïö©
  if (!http.begin(secureClient, SERVER_URL)) {
    Serial.println("‚ùå http.begin Ïã§Ìå®");
    return;
  }

  http.addHeader("Content-Type", "application/json");

  String json = "{";
  json += "\"device_id\":\"A-10\",";
  json += "\"value\":" + String(val) + ",";
  json += "\"led\":"   + String(led);
  json += "}";

  Serial.print("‚û° ÏÑúÎ≤Ñ POST: ");
  Serial.println(json);

  int code = http.POST(json);
  Serial.print("‚¨Ö ÏÑúÎ≤Ñ ÏùëÎãµ: ");
  Serial.println(code);

  http.end();
}


// ======== SETUP ========
void setup() {
  Serial.begin(115200);
  delay(800);

  connectWiFi();

  // BLE Ï¥àÍ∏∞Ìôî
  BLEDevice::init("SmartFSR-A10");
  BLEServer* pServer = BLEDevice::createServer();
  BLEService* pService = pServer->createService(SERVICE_UUID);

  pCharacteristic = pService->createCharacteristic(
      CHARACTERISTIC_UUID,
      BLECharacteristic::PROPERTY_READ |
      BLECharacteristic::PROPERTY_NOTIFY
  );

  pCharacteristic->addDescriptor(new BLE2902());
  pService->start();
  BLEDevice::startAdvertising();

  Serial.println("üì° BLE Advertising ÏãúÏûë!");
}


// ======== LOOP ========
unsigned long lastSend = 0;

void loop() {
  unsigned long now = millis();

  if (now - lastSend >= 10000) {  // 10Ï¥àÎßàÎã§ Ï†ÑÏÜ°
    lastSend = now;

    int val = analogRead(SENSOR_PIN);
    int ledState = (val > THRESHOLD) ? 1 : 0;

    Serial.print("üìü FSR ÏÑºÏÑúÍ∞í: ");
    Serial.print(val);
    Serial.print(" / LED: ");
    Serial.println(ledState);

    // BLE Notify Ï†ÑÏÜ°
    String msg = String(val) + "\t" + String(ledState);
    pCharacteristic->setValue(msg.c_str());
    pCharacteristic->notify();

    // ÏÑúÎ≤Ñ Ï†ÑÏÜ°
    postToServer(val, ledState);
  }
}
